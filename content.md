## ベイズ統計モデリング輪読会#6
### 第11章 帰無仮説有意性検定
<br>
Yusuke Goto

========================================
### Outline
- - -
1. 自己紹介

========================================
### 帰無仮説有意性検定(NHST)とは？
- - -
Null Hypothesis Significance Testingの略。<br>
頻度主義の手法であり、次の手続きで行われる。

1. 帰無仮説を設定する<br>
「コインの表が出る確率$\theta$は0.5である」

1. $p$値を計算する<br>
(p値の意味と計算方法は後述)

1. $p$値が閾値より小：仮説は棄却<br>
$p$値が閾値より大：仮説は棄却されない

========================================
### $p$値とは？(1/2)
- - -
確かめたい帰無仮説：コインの表が出る確率$\theta$は$0.5$である

仮説を確認するため、表が出る回数を取得
  - 1回24回中、1回表が出た場合<br>
  →極端すぎる。帰無仮説が間違っていそうだ
  - 24回中、11回表が出た場合<br>
  →あまり極端ではない。帰無仮説が間違いとはいえなさそうだ
  - 24回中、7回表が出た場合<br>
  →どうしたものか…

帰無仮説のもとでデータの「極端さ」を定量的に表現する

========================================
### $p$値とは？(2/2)
- - -
$p$値の定義：ある帰無仮説が正しい場合に、実際にサンプリングされたデータよりもさらに「極端」なデータが得られる確率

$$
p値 =p\(D\_{\theta,I} \succeq D\_{実際}|\theta,I\) \\
$$
<br>
$D$: 記述統計量。コインの場合は(表の出た回数$z$)/(コイントス回数$N$)<br>
$I$: サンプリング方法を決める意図(後述)<br>
$\succeq$:左の$D$が右の$D$よりも「極端である」ことを表す<br>

コイントスの場合を具体的に書くと
\begin{eqnarray}
p\(右端\)=p\( (z/N)\_{\theta,I} \ge (z/N)\_{実際} |\theta,I\)
\\\
p\(左端\)=p\( (z/N)\_{\theta,I} \le (z/N)\_{実際} |\theta,I\)
\end{eqnarray}

========================================
### 3種類のサンプリング意図$I$ごとに$p$値を計算してみる
- - -
実験者「$\theta=0.5$だと思うんだけど、実験してくれない？」<br>
助手　「分かりました。」<br>
　　　（2分後）<br>
助手　「実験の結果でました。こんな感じです。<br>
　　　　裏裏表表裏裏表裏裏裏裏裏裏裏裏裏表裏裏表表裏裏表」<br>
実験者「24回中7回表が出たわけか。<br>
　　　　トスの回数はどうやって決めたの？」<br>

ここの助手の返事でパターンが分岐<br>
1. 「24回トスしたらやめよう、と最初から決めてました。」<br>
1. 「7回表が出たらやめよう、と最初から決めてました。」<br>
1. 「制限時間の2分になったらやめよう、最初から決めてました。」<br>

----------------------------------------
### サンプリング空間
- - -
サンプリング意図を細かく気にする理由は、<br>
意図次第でサンプリング空間が変わるから！

========================================
### 意図1:トス回数$N$を固定した場合(1/2)
- - -
$N$を固定した時に表が$z$回出る確率は、次の二項分布に従う。
$$
p(z|N,\theta)=
\begin{pmatrix}
N \\\
z
\end{pmatrix}
\theta^z
\(1-\theta\)^{N-z}
$$

$p$値はグラフ中の+矢印部分を足しあげた値$3.2\%$となる。
<!-- ここにグラフ入れる -->

----------------------------------------
### $p$値計算時の注意
- - -
$p$値は
$$
p(z=7|N=24,\theta=0.5)=2.063\%
$$
ではなく
$$
\sum_{z=1}^{7} p(z|N=24,\theta=0.5)=3.2\%
$$
が正しい。単一の$z$の確率だけでは極端さを評価できないため。

例えば$N=1000$の場合は、$\theta=0.5$が正しかったとしても$z=500$となる確率は$2.5\%$だが、明らかにこの値の小ささだけで極端と判定すべきではない。

----------------------------------------
### 実際にプロット比較してみた
- - -
<img src="img/pic11_3_N24.png"   alt="Drawing" style="width: 400px;" align="center"/>
<img src="img/pic11_3_N1000.png" alt="Drawing" style="width: 400px;" align="center"/>

========================================
### 意図1:トス回数$N$を固定した場合(2/2)
- - -
今回は$z/N$が極端に小さいかどうか（＝分布の左裾側に外れているか）を検定したいので、片側確率を評価する。


慣習的に臨界確率は両側$5\%$、片側$2.5\%$を使う。

今回は$p=3.2\%>2.5\%$より、帰無仮説「$\theta=0.5$」の元で$z=7$は極端とは判定されない。
よって、帰無仮説は棄却されない。<br>
(※「採択する」ほど強い主張ではない)
<!-- ここにグラフ入れる -->

========================================
### 意図2:表の回数zを固定した場合(1/2)
- - -
$N$回目のトスで$z$回目の表が出る
<br>
＝$N-1$回目までのトスで$z-1$回表が出ており、次のトスで表が出る
\begin{eqnarray}
p(N|z,\theta)
&=&
\begin{pmatrix}
N-1 \\\ z - 1
\end{pmatrix}
\theta^{z-1} (1-\theta)^{\\{(N-1)-(z-1)\\}}
\ \ \ \times \theta
\\\
&=&
\frac{z}{N}
\begin{pmatrix}
N \\\ z
\end{pmatrix}
\theta^{z} (1-\theta)^{N-z}
\end{eqnarray}

<!-- ここにグラフ入れる -->

========================================
### 意図2:表の回数zを固定した場合(2/2)
- - -
$p$値は$1.7\%$。片側閾値$2.5\%$より小さい。

つまり帰無仮説「$\theta=0.5$」が正しいと主張するには、得られたデータがあまりに極端。
仮説は棄却される。

## さっきは棄却されなかったのに、
## サンプリング意図が違うだけで結果が変わった！

----------------------------------------
### 実は、$z$を固定する方法はあまり良くない。
- - -
サンプリングの後半に出てくるかもしれない補償的なデータを捨てるので、バイアスがかかる。

========================================
### 意図3:制限時間を固定した場合(1/2)
- - -
この場合は$N$も$z$も共に確率変数。

決められた時間内のイベント発生数のモデルはポアソン分布
$$
p(N|\lambda) = \frac{\lambda^{N}e^{-\lambda}}{N!}
\ \ \ \ \ \(N>0\)
$$
が良い(ここで$\lambda$は分布の平均であり、分散でもある)
　　　　　　　　　
<img src="img/pic11_5_poisson.png"   alt="Drawing" style="width: 300px;"/>

$N$はポアソン分布に従って決まり、各$N$に対する$z$が二項分布で決まるので、
$(N,z)$の分布は二項分布のポアソン重み付き和になる。

========================================
### 意図3:制限時間を固定した場合(2/2)
- - -

結果、$p$値は$2.4\%$となり、片側閾値$2.5\%$よりわずかに小さく帰無仮説「$\theta=0.5$」は棄却されるが。。。これを信じて良いものか？
今回は$\lambda=24$を仮定したが、コイントス1回平均6秒とすれば$\lambda=20$とすべきで、その場合$p$値は$3.5\%$になる（あっさり検定結果が変わった！）
そもそもサンプリング意図によって結果が変わることは分かっているし。。。

========================================
# 結論
<br>
### 帰無仮説ではなく、帰するべき事前分布を設定しよう！
### 　　　　　　　　　　　　　　　　　　　　〜おわり〜
